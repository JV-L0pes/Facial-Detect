<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Valida√ß√£o - Sistema Reconhecimento Facial</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üë§</text></svg>">
    <link rel="stylesheet" href="/css/styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="header-content">
                <div class="logo">
                    <i class="fas fa-user-check"></i>
                    <h1>Sistema Reconhecimento Facial</h1>
                </div>
                <nav class="nav">
                    <a href="/" class="nav-link">
                        <i class="fas fa-home"></i> In√≠cio
                    </a>
                    <a href="/cadastro" class="nav-link">
                        <i class="fas fa-user-plus"></i> Cadastro
                    </a>
                    <a href="/validacao" class="nav-link active">
                        <i class="fas fa-camera"></i> Valida√ß√£o
                    </a>
                    <a href="/admin" class="nav-link">
                        <i class="fas fa-cog"></i> Admin
                    </a>
                </nav>
            </div>
        </header>

        <main class="main">
            <div class="detect-grid">
                <section class="detect-left">
                    <div class="video-card" id="videoCard">
                        <div class="video-header">
                            <div class="video-title"><i class="fas fa-video"></i> C√¢mera</div>
                            <div id="liveBadge" class="badge">OFF</div>
                        </div>
                        <div class="video-shell">
                            <video id="webcamVideo" class="webcam-video" autoplay muted></video>
                            <canvas id="overlayCanvas" class="overlay-canvas"></canvas>
                        </div>
                        <div class="video-controls">
                            <button id="startBtn" class="webcam-btn">
                                <i class="fas fa-play"></i> Iniciar C√¢mera
                            </button>
                            <button id="stopBtn" class="webcam-btn stop" style="display: none;">
                                <i class="fas fa-stop"></i> Parar
                            </button>
                        </div>
                    </div>
                </section>

                <aside class="detect-right">
                    <div class="panel">
                        <div class="panel-header">
                            <i class="fas fa-shield-alt"></i>
                            <span>Status da Valida√ß√£o</span>
                        </div>
                        <div class="status-row">
                            <span class="label">Estado</span>
                            <span id="statusBadge" class="chip chip-warning"><i class="fas fa-exclamation-triangle"></i> Aguardando</span>
                        </div>
                        <div class="status-row">
                            <span class="label">Usu√°rio</span>
                            <span id="userLabel" class="muted">Desconhecido</span>
                        </div>
                        <div class="status-row">
                            <span class="label">Confian√ßa</span>
                            <div class="meter">
                                <div id="confBar" class="meter-bar" style="width: 0%"></div>
                            </div>
                            <span id="confText" class="meter-text">0%</span>
                        </div>
                        <div class="status-row">
                            <span class="label">Liveness</span>
                            <span id="livenessChip" class="chip chip-warning"><i class="fas fa-user-secret"></i> Em an√°lise</span>
                        </div>
                    </div>

                    <div class="hint">
                        <i class="fas fa-info-circle"></i>
                        Dicas: fique de frente para a c√¢mera, com boa ilumina√ß√£o e mova-se levemente para liveness.
                    </div>
                </aside>
            </div>
        </main>

        <footer class="footer">
            <p>&copy; 2025 Sistema Reconhecimento Facial. Demo para controle de acesso.</p>
        </footer>
    </div>

    <script>
        const webcamVideo = document.getElementById('webcamVideo');
        const overlayCanvas = document.getElementById('overlayCanvas');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const liveBadge = document.getElementById('liveBadge');

        const statusBadge = document.getElementById('statusBadge');
        const userLabel = document.getElementById('userLabel');
        const confBar = document.getElementById('confBar');
        const confText = document.getElementById('confText');
        const livenessChip = document.getElementById('livenessChip');
        const videoCard = document.getElementById('videoCard');

        let stream = null;
        let isRunning = false;
        let validationInterval = null;

        startBtn.addEventListener('click', startWebcam);
        stopBtn.addEventListener('click', stopWebcam);

        async function startWebcam() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { width: 640, height: 480, facingMode: 'user' } 
                });
                webcamVideo.srcObject = stream;
                isRunning = true;

                startBtn.style.display = 'none';
                stopBtn.style.display = 'inline-block';

                setLiveState(true);
                setStatus('warning', 'Aguardando reconhecimento');
                setLiveness('warning', 'Em an√°lise');
                setConfidence(0);
                setUser('Desconhecido');

                validationInterval = setInterval(validateFrame, 3000);
            } catch (error) {
                console.error('Erro ao acessar c√¢mera:', error);
                setStatus('error', 'Erro ao acessar c√¢mera');
                setLiveState(false);
            }
        }

        function stopWebcam() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            webcamVideo.srcObject = null;
            isRunning = false;

            startBtn.style.display = 'inline-block';
            stopBtn.style.display = 'none';

            clearInterval(validationInterval);
            validationInterval = null;

            setLiveState(false);
            setStatus('warning', 'C√¢mera parada');
            setConfidence(0);
            setUser('Desconhecido');
            setLiveness('warning', 'Em an√°lise');
            clearOverlay();
        }

        function setLiveState(on) {
            liveBadge.textContent = on ? 'LIVE' : 'OFF';
            liveBadge.className = 'badge ' + (on ? 'badge-live' : '');
        }

        function setStatus(type, text) {
            const icon = type === 'success' ? 'check-circle' : type === 'error' ? 'times-circle' : 'exclamation-triangle';
            statusBadge.className = `chip chip-${type}`;
            statusBadge.innerHTML = `<i class="fas fa-${icon}"></i> ${text}`;
            videoCard.classList.remove('card-success','card-error');
            if (type === 'success') videoCard.classList.add('card-success');
            if (type === 'error') videoCard.classList.add('card-error');
        }

        function setUser(text) {
            userLabel.textContent = text;
        }

        function setConfidence(pct) {
            const clamped = Math.max(0, Math.min(100, pct));
            confBar.style.width = clamped + '%';
            confText.textContent = clamped.toFixed(1) + '%';
            confBar.className = 'meter-bar ' + (clamped >= 75 ? 'good' : clamped >= 45 ? 'warn' : 'low');
        }

        function setLiveness(type, text) {
            const icon = type === 'success' ? 'user-check' : type === 'error' ? 'user-slash' : 'user-secret';
            livenessChip.className = `chip chip-${type}`;
            livenessChip.innerHTML = `<i class="fas fa-${icon}"></i> ${text}`;
        }

        function clearOverlay() {
            const ctx = overlayCanvas.getContext('2d');
            ctx.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);
        }

        async function validateFrame() {
            if (!isRunning) return;
            try {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = webcamVideo.videoWidth;
                canvas.height = webcamVideo.videoHeight;
                if (!canvas.width || !canvas.height) return;

                ctx.drawImage(webcamVideo, 0, 0);
                const imageData = canvas.toDataURL('image/jpeg', 0.8);

                const response = await fetch('/api/validate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ image: imageData })
                });

                const data = await response.json();
                if (data.success) {
                    handleValidationResult(data);
                } else {
                    setStatus('warning', data.message || 'Aguardando rostos');
                    setConfidence(0);
                    setUser('Desconhecido');
                    setLiveness('warning', 'Em an√°lise');
                }
            } catch (error) {
                console.error('Erro na valida√ß√£o:', error);
                setStatus('error', 'Erro de conex√£o');
            }
        }

        function handleValidationResult(data) {
            const { access_granted, liveness_passed, confidence, user_id } = data;
            setConfidence(confidence * 100);
            setLiveness(liveness_passed ? 'success' : 'warning', liveness_passed ? 'Aprovado' : 'Em an√°lise');
            setUser(user_id ? `Reconhecido (ID ${user_id})` : 'Desconhecido');

            if (access_granted) {
                setStatus('success', 'Acesso Liberado');
                // Detec√ß√£o continua at√© o usu√°rio clicar em "Parar"
            } else {
                if (!liveness_passed) setStatus('warning', 'Liveness em an√°lise');
                else setStatus('error', 'Usu√°rio n√£o reconhecido');
            }
        }

        window.addEventListener('resize', syncCanvas);
        webcamVideo.addEventListener('loadedmetadata', syncCanvas);
        webcamVideo.addEventListener('resize', syncCanvas);
        function syncCanvas() {
            // Obter dimens√µes reais do v√≠deo
            const videoWidth = webcamVideo.videoWidth;
            const videoHeight = webcamVideo.videoHeight;
            
            if (!videoWidth || !videoHeight) return;
            
            // Obter dimens√µes do container
            const containerWidth = webcamVideo.parentElement.clientWidth;
            const containerHeight = webcamVideo.parentElement.clientHeight;
            
            // Calcular escala para manter propor√ß√£o (como object-fit: contain)
            const scaleX = containerWidth / videoWidth;
            const scaleY = containerHeight / videoHeight;
            const scale = Math.min(scaleX, scaleY);
            
            // Calcular dimens√µes finais do v√≠deo
            const finalWidth = videoWidth * scale;
            const finalHeight = videoHeight * scale;
            
            // Calcular offset para centralizar
            const offsetX = (containerWidth - finalWidth) / 2;
            const offsetY = (containerHeight - finalHeight) / 2;
            
            // Configurar canvas para corresponder exatamente ao v√≠deo
            overlayCanvas.width = videoWidth;
            overlayCanvas.height = videoHeight;
            
            // Posicionar e dimensionar o canvas
            overlayCanvas.style.position = 'absolute';
            overlayCanvas.style.left = offsetX + 'px';
            overlayCanvas.style.top = offsetY + 'px';
            overlayCanvas.style.width = finalWidth + 'px';
            overlayCanvas.style.height = finalHeight + 'px';
            overlayCanvas.style.transform = 'scale(1)';
        }

        window.addEventListener('beforeunload', () => { stopWebcam(); });
    </script>

    <style>
        .detect-grid { display: grid; grid-template-columns: 4fr 1fr; gap: 1.5rem; }
        @media (max-width: 1200px) { .detect-grid { grid-template-columns: 3fr 1fr; } }
        @media (max-width: 980px) { .detect-grid { grid-template-columns: 1fr; } }

        .video-card { background: #fff; border: 1px solid #e2e8f0; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.08); overflow: hidden; transition: box-shadow .2s ease, border-color .2s ease; }
        .video-card.card-success { border-color: #22c55e; box-shadow: 0 10px 25px -4px rgba(34,197,94,0.25); }
        .video-card.card-error { border-color: #ef4444; box-shadow: 0 10px 25px -4px rgba(239,68,68,0.25); }

        .video-header { display: flex; align-items: center; justify-content: space-between; padding: 0.875rem 1rem; border-bottom: 1px solid #e2e8f0; }
        .video-title { font-weight: 700; color: #1e293b; display: flex; gap: .5rem; align-items: center; }
        .badge { background: #e2e8f0; color: #334155; border-radius: 999px; padding: .25rem .75rem; font-weight: 700; font-size: .8rem; }
        .badge-live { background: #dcfce7; color: #166534; border: 1px solid #86efac; }

        .video-shell { position: relative; width: 100%; height: 500px; background: #0b1220; display: flex; align-items: center; justify-content: center; }
        .webcam-video { max-width: 100%; max-height: 100%; object-fit: contain; border-radius: 0; }
        .overlay-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }

        .video-controls { display: flex; gap: .75rem; padding: 1rem; border-top: 1px solid #e2e8f0; }

        .detect-right { display: flex; flex-direction: column; gap: 1rem; }
        .panel { background: #fff; border: 1px solid #e2e8f0; border-radius: 12px; padding: 1.25rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.06); }
        .panel-header { display: flex; align-items: center; gap: .5rem; font-weight: 700; color: #1e293b; margin-bottom: .75rem; }
        .status-row { display: grid; grid-template-columns: 110px 1fr auto; align-items: center; gap: .75rem; padding: .5rem 0; }
        .label { color: #64748b; font-weight: 600; }
        .muted { color: #475569; }

        .chip { display: inline-flex; align-items: center; gap: .5rem; padding: .375rem .75rem; border-radius: 999px; font-weight: 700; font-size: .85rem; border: 1px solid transparent; }
        .chip-success { background: #f0fdf4; color: #166534; border-color: #86efac; }
        .chip-warning { background: #fffbeb; color: #92400e; border-color: #fed7aa; }
        .chip-error { background: #fef2f2; color: #991b1b; border-color: #fecaca; }

        .meter { height: 10px; background: #e2e8f0; border-radius: 999px; overflow: hidden; position: relative; }
        .meter-bar { height: 100%; width: 0%; transition: width .3s ease; background: #93c5fd; }
        .meter-bar.good { background: #22c55e; }
        .meter-bar.warn { background: #f59e0b; }
        .meter-bar.low { background: #ef4444; }
        .meter-text { font-weight: 700; color: #334155; min-width: 60px; text-align: right; }

        .hint { background: #f8fafc; border: 1px dashed #cbd5e1; color: #475569; border-radius: 12px; padding: .875rem 1rem; font-size: .9rem; display: flex; gap: .5rem; align-items: center; }
    </style>
</body>
</html>
